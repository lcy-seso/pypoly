(def
  (ident forward)
  (decl
    (list
      (param
        (ident self)
        (option)
        (option)
        (False))
      (param
        (ident input)
        (option
          (subscript
            (variable (ident List))
            (list
              (subscript
                (variable (ident List))
                (list
                  (variable
                    (ident Tensor)))))))
        (option)
        (False))
      (param
        (ident batch_size)
        (option (variable (ident int)))
        (option)
        (False))
      (param
        (ident seq_lens)
        (option
          (subscript
            (variable (ident List))
            (list
              (variable (ident int)))))
        (option)
        (False))
      (param
        (ident cells)
        (option
          (subscript
            (variable (ident List))
            (list
              (.
                (variable (ident nn))
                (ident Module)))))
        (option)
        (False))
      (param
        (ident depth)
        (option (variable (ident int)))
        (option)
        (False))
      (param
        (ident output_size)
        (option (variable (ident int)))
        (option)
        (False)))
    (option
      (variable (ident TensorArray))))
  (list
    (assign
      (list (variable (ident output)))
      (option
        (apply
          (variable
            (ident TensorArray))
          (list
            (variable
              (ident batch_size))
            (variable (ident seq_lens))
            (variable (ident depth))
            (variable
              (ident output_size)))
          (list)))
      (option))
    (for
      (list (variable (ident i)))
      (list
        (apply
          (variable (ident range))
          (list
            (variable
              (ident batch_size)))
          (list)))
      (list
        (assign
          (list
            (variable (ident seq_len)))
          (option
            (subscript
              (variable
                (ident seq_lens))
              (list
                (variable (ident i)))))
          (option))
        (for
          (list (variable (ident j)))
          (list
            (apply
              (variable (ident range))
              (list
                (variable
                  (ident seq_len)))
              (list)))
          (list
            (for
              (list
                (variable (ident k)))
              (list
                (apply
                  (variable
                    (ident range))
                  (list
                    (variable
                      (ident depth)))
                  (list)))
              (list
                (if
                  (eq
                    (variable
                      (ident j))
                    (const 0))
                  (list
                    (assign
                      (list
                        (variable
                          (ident
                            h_prev)))
                      (option
                        (.
                          (variable
                            (ident
                              self))
                          (ident
                            init_state)))
                      (option)))
                  (list
                    (assign
                      (list
                        (variable
                          (ident
                            h_prev)))
                      (option
                        (apply
                          (.
                            (variable
                              (ident
                                output))
                            (ident
                              read))
                          (list
                            (variable
                              (ident i))
                            (-
                              (variable
                                (ident
                                  j))
                              (const 1))
                            (variable
                              (ident k)))
                          (list)))
                      (option))))
                (if
                  (eq
                    (variable
                      (ident k))
                    (const 0))
                  (list
                    (assign
                      (list
                        (variable
                          (ident x)))
                      (option
                        (subscript
                          (subscript
                            (variable
                              (ident
                                input))
                            (list
                              (variable
                                (ident
                                  i))))
                          (list
                            (variable
                              (ident j)))))
                      (option)))
                  (list
                    (assign
                      (list
                        (variable
                          (ident x)))
                      (option
                        (apply
                          (.
                            (variable
                              (ident
                                output))
                            (ident
                              read))
                          (list
                            (variable
                              (ident i))
                            (variable
                              (ident j))
                            (-
                              (variable
                                (ident
                                  k))
                              (const 1)))
                          (list)))
                      (option))))
                (assign
                  (list
                    (variable
                      (ident h)))
                  (option
                    (apply
                      (subscript
                        (variable
                          (ident cells))
                        (list
                          (variable
                            (ident k))))
                      (list
                        (variable
                          (ident x))
                        (variable
                          (ident
                            h_prev)))
                      (list)))
                  (option))
                (expression statement
                  (apply
                    (.
                      (variable
                        (ident output))
                      (ident write))
                    (list
                      (variable
                        (ident h))
                      (variable
                        (ident i))
                      (variable
                        (ident j))
                      (variable
                        (ident k)))
                    (list)))))))))))
